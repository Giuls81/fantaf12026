# FantaF1 2026: Architecture & Scoring Engine

This document provides a comprehensive overview of the FantaF1 2026 application structure, its scoring logic, and a post-mortem of the technical challenges encountered during the early 2026 season simulations.

---

## 1. System Architecture

The application follows a modern cloud-native architecture, leveraging a hybrid of automated Edge Functions and a localized admin control layer.

### Tech Stack
- **Frontend**: React + Vite + TypeScript. Wrapped with **Capacitor** for deployment on Android and iOS.
- **Backend (API)**: **Supabase Edge Functions** (Deno + Hono). This is where 90% of the game logic resides.
- **Database**: PostgreSQL (Supabase) using `postgres.js` for high-performance raw SQL queries.
- **Mobile Infrastructure**: **Capacitor** for native bridge functionality (AdMob, RevenueCat).

### Directory Structure
- `/web`: The entire React frontend.
  - `App.tsx`: The main entry point (UI & State).
  - `constants.ts`: Source of truth for scoring constants and driver data.
- `/supabase/functions/fanta-api`: The centralized backend scoring engine.
- `/api`: Local Node.js utilities for verification, simulation, and data analysis.
- `/android` & `/ios`: Native platform projects generated by Capacitor.

---

## 2. The Scoring Engine (The Heart of the Game)

The logic is centralized in the `calculateWeekendPoints` function within `supabase/functions/fanta-api/index.ts`.

### How Points are Calculated
1. **Raw Components**: The engine calculates basic points for:
   - Race Classification (P1-P20).
   - Overtakes (Positions Gained/Lost based on Grid vs. Finish).
   - Teammate Duel (Beating/Losing to teammate).
   - Quali Performance (Q1/Q2/Q3 reach + Pole).
   - DNFs & Penalties.
2. **Sprint Logic**: Sprint weekends have additional components for the Sprint Race and Sprint Qualifying (Pole only).
3. **Multipliers**:
   - **Constructor Multiplier**: Applied to positive scoring components of the driver.
   - **Captain Multiplier**: The final driver score is multiplied by **2.0**.
   - **Reserve Driver**: The score is multiplied by **0.5** only if a main driver DNFs.

---

## 3. Post-Mortem: Recent Technical Issues

### Issue 1: Sprint Points Aggregation Error
- **What happened**: Points from the Sprint Race and Sprint Qualifying were being summed before being displayed in the UI.
- **Why**: The API returned a single `driverSprintPoints` object for the entire weekend.
- **The Fix**: Separated the backend return into `driverSprintPoints` and `driverSprintQualiPoints`. Updated the UI to map these correctly to their respective tabs.

### Issue 2: The "Double Multiplier" Bug
- **What happened**: Certain drivers (e.g., George Russell) were showing 5x higher points than expected.
- **Why**: In the **simulation** logic (`/simulate-china-test`), the constructor multiplier was being applied twice:
  1. Once inside the core `calculateWeekendPoints` engine.
  2. A second time in the simulation endpoint loop that saves results to the database.
- **The Fix**: Removed the redundant multiplication from the endpoint and unified the logic to follow the database rules.

---

## 4. Ensuring Quality & Future Reliability

To prevent these issues in the future, we have implemented several verification layers:

### A. Local Verification Scripts
Located in `/api`, these scripts allow for a "sanity check" before and after race simulation:
- `final_verification_v3.js`: Compares the total points stored in the DB with the sum of individual Race Results.
- `breakdown_check.js`: Dumps the specific points breakdown for every driver in a team.

### B. Unit Testing Strategy
- Core logic in `calculateWeekendPoints` is isolated from external dependencies (SQL/Network).
- **Future Goal**: Implement Vitest suites for the `fanta-api` function to test edge cases (e.g., 0-point DNFs, negative multipliers).

### C. Deployment Checklist
1. **Sync Rules**: Ensure `web/constants.ts` and the `League.rules` in the DB are in sync.
2. **Simulation Check**: Run `simulate-china-test` and inspect results via `breakdown_check.js`.
3. **Database Guardrails**: Decimals are now enforced via `DOUBLE PRECISION` to avoid rounding errors in multipliers.

---
*Last updated: February 2026*
