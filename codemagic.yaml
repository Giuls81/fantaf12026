workflows:
  ios_testflight:
    name: iOS Release (Capacitor) - TestFlight
    max_build_duration: 90
    environment:
      node: 22
      xcode: latest
      vars:
        IOS_DIR: "ios/App"
        XCODE_SCHEME: "App"
        BUNDLE_ID: "com.fantaf1.app"
        VITE_API_URL: "https://laqjyqfnjnofmvgedunl.supabase.co/functions/v1/fanta-api"
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.fantaf1.app
    scripts:
      - name: Install deps
        script: npm ci
      - name: Build web
        script: |
          cd web
          npm ci
          VITE_API_URL=$VITE_API_URL npm run build
      - name: Sync Capacitor iOS
        script: npx cap sync ios
      - name: Install iOS pods (if Podfile exists)
        script: |
          if [ -f "$IOS_DIR/Podfile" ]; then
            cd "$IOS_DIR"
            pod install
          fi
      - name: Build IPA (signed) + Upload to TestFlight
        script: |
          cd "$IOS_DIR"
          if [ -d "App.xcworkspace" ]; then
            BUILD_TARGET="-workspace App.xcworkspace"
          else
            BUILD_TARGET="-project App.xcodeproj"
          fi
          xcodebuild \
            $BUILD_TARGET \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$CM_BUILD_DIR/build/ios/archive/App.xcarchive" \
            archive
          cat > "$CM_BUILD_DIR/exportOptions.plist" <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF
          xcodebuild -exportArchive \
            -archivePath "$CM_BUILD_DIR/build/ios/archive/App.xcarchive" \
            -exportOptionsPlist "$CM_BUILD_DIR/exportOptions.plist" \
            -exportPath "$CM_BUILD_DIR/build/ios/ipa"
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/archive/*.xcarchive
    publishing:
      app_store_connect:
        submit_to_testflight: true

  android_release:
    name: Android Release (APK/AAB)
    max_build_duration: 60
    environment:
      node: 22
      vars:
        ANDROID_DIR: "android"
        VITE_API_URL: "https://laqjyqfnjnofmvgedunl.supabase.co/functions/v1/fanta-api"
    scripts:
      - name: Install deps
        script: npm ci
      - name: Build web
        script: |
          cd web
          npm ci
          VITE_API_URL=$VITE_API_URL npm run build
      - name: Add/Sync Android
        script: |
          npx cap add android || true
          npx cap sync android
      - name: Build Android APK
        script: |
          cd android
          ./gradlew assembleRelease
    artifacts:
      - android/app/build/outputs/apk/release/*.apk
      - android/app/build/outputs/bundle/release/*.aab
